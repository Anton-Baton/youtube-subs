version: '2'

services:
  data:
    restart: always
    image: alpine
    volumes:
      - /var/lib/postgresql
    command: "true"

  # PostgreSQL database
  db:
    image: postgres:9.4
    hostname: db
    env_file: .env
    volumes_from:
      - data
    ports:
      - "5432:5432"

  # RabbitMQ
  rabbit:
    hostname: rabbit
    image: rabbitmq:3.6.0
    ports:
      - "5673:5672"  # we forward this port because it's useful for debugging
      - "15673:15672"  # here, we can access rabbitmq management plugin

  # Celery worker
  celery:
    build:
      context: .
      dockerfile: Dockerfile
    command: ./run_celery.sh
    env_file: .env
    ports:
      - "5556:5555"
    volumes:
      - .:/app
    links:
      - db
      - rabbit
    depends_on:
      - rabbit

  # Django web server
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: backend
    hostname: backend
    env_file: .env
    command: ./run_server.sh
    volumes:
      - .:/app  # mount current directory inside container
    ports:
      - "8000:8000"
    # set up links so that web knows about db, rabbit and redis
    links:
      - db
      - rabbit
    depends_on:
      - db
      - rabbit
      - celery

  # Frontend container (static React files, index.html and bundle.js, served with nginx)
  frontend:
    build: ../subtitles-frontend
    volumes:
      - ../subtitles-frontend:/app/frontend
    container_name: frontend
    hostname: frontend
#    working_dir: /app/frontend
    links:
      - backend

  nginx_proxy:
    build: ./configs/nginx
    container_name: nginx_proxy
    # See the file nginx_proxy.conf
    # It uses these links to connect you to the two containers
    links:
      - backend
      - frontend
    ports:
      - '80:80'